'use strict';

try {
  var async_hooks = require('async_hooks');
  if ('function' !== typeof async_hooks.executionAsyncId) {
    throw new Error(`Missing executionAsyncId function`);
  }
} catch (err) {
  async_hooks = undefined;
  console.warn(`Unable to load async_hooks module (Node 8.2+ required).\n  (reason: ${err.message})`);
}

const { Traceback } = require('./traceback');

const db_trace = new Map();

const hook_trace = async_hooks ? async_hooks.createHook({
  destroy(asyncId) {
    db_trace.delete(asyncId);
  },
  init(asyncId, type, triggerId) {
    const parent = db_trace.get(triggerId);
    const depth = undefined !== parent ? 1 + parent.depth : 1;
    const key = `CPS[${depth}]::${type}`;

    const err = new Error(key);
    err.triggerId = triggerId;
    err.depth = depth;

    if (undefined !== parent) {
      let early = parent.early;
      if (undefined === early && 11 === depth) {
        early = asFrameList(triggerId);
      }
      if (undefined !== early) {
        Object.defineProperties(err, { early: { value: early } });
      }
    }

    db_trace.set(asyncId, err);
  } }) : null;

function asFrameList(triggerId, limit) {
  const res = [];
  if (triggerId.triggerId && triggerId.depth) {
    res.push(triggerId);
    triggerId = triggerId.triggerId;
  }

  while (triggerId) {
    const frame = db_trace.get(triggerId);
    if (frame === undefined) {
      break;
    }
    res.push(frame);
    if (res.length >= limit) {
      break;
    }
    triggerId = frame.triggerId;
  }

  return res;
}

const api = {
  Traceback,

  isSupported() {
    return !!hook_trace;
  },
  isActive() {
    return hook_trace ? hook_trace.active : undefined;
  },

  install() {
    Error.stackTraceLimit = Math.max(30, Error.stackTraceLimit);
    if (hook_trace) {
      hook_trace.enable();
      hook_trace.active = true;
    }
    return this;
  },

  uninstall() {
    db_trace.clear();
    if (hook_trace) {
      hook_trace.disable();
      hook_trace.active = false;
    }
    return this;
  },

  withTraceback(Traceback) {
    if ('function' !== typeof Traceback) {
      throw new TypeError(`Expected an Traceback function supporting new`);
    }
    return { Traceback, __proto__: this };
  },

  capture(Traceback = this.Traceback) {
    let raw_trace = async_hooks ? db_trace.get(async_hooks.executionAsyncId()) : undefined;

    if (undefined === raw_trace) {
      raw_trace = new Error(`CPS[?]::unavailable`);
    }
    return new Traceback(raw_trace, asFrameList);
  },

  error(error) {
    return this.capture().withError(error);
  },

  async_stack() {
    return this.capture().async_stack();
  } };

api.api = api.default = api;
module.exports = exports = api;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NvZGUvaW5kZXguanN5Il0sIm5hbWVzIjpbImFzeW5jX2hvb2tzIiwicmVxdWlyZSIsImV4ZWN1dGlvbkFzeW5jSWQiLCJFcnJvciIsImVyciIsInVuZGVmaW5lZCIsImNvbnNvbGUiLCJ3YXJuIiwibWVzc2FnZSIsIlRyYWNlYmFjayIsImRiX3RyYWNlIiwiTWFwIiwiaG9va190cmFjZSIsImNyZWF0ZUhvb2siLCJkZXN0cm95IiwiYXN5bmNJZCIsImRlbGV0ZSIsImluaXQiLCJ0eXBlIiwidHJpZ2dlcklkIiwicGFyZW50IiwiZ2V0IiwiZGVwdGgiLCJrZXkiLCJlYXJseSIsImFzRnJhbWVMaXN0IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydGllcyIsInZhbHVlIiwic2V0IiwibGltaXQiLCJyZXMiLCJwdXNoIiwiZnJhbWUiLCJsZW5ndGgiLCJhcGkiLCJpc1N1cHBvcnRlZCIsImlzQWN0aXZlIiwiYWN0aXZlIiwiaW5zdGFsbCIsInN0YWNrVHJhY2VMaW1pdCIsIk1hdGgiLCJtYXgiLCJlbmFibGUiLCJ1bmluc3RhbGwiLCJjbGVhciIsImRpc2FibGUiLCJ3aXRoVHJhY2ViYWNrIiwiVHlwZUVycm9yIiwiX19wcm90b19fIiwiY2FwdHVyZSIsInJhd190cmFjZSIsImVycm9yIiwid2l0aEVycm9yIiwiYXN5bmNfc3RhY2siLCJkZWZhdWx0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJO0FBQ0YsTUFBSUEsY0FBY0MsUUFBUSxhQUFSLENBQWxCO0FBQ0EsTUFBRyxlQUFlLE9BQU9ELFlBQVlFLGdCQUFyQyxFQUF3RDtBQUN0RCxVQUFNLElBQUlDLEtBQUosQ0FBYSxtQ0FBYixDQUFOO0FBQXFEO0FBQUEsQ0FIekQsQ0FJQSxPQUFNQyxHQUFOLEVBQVk7QUFDVkosZ0JBQWNLLFNBQWQ7QUFDQUMsVUFBUUMsSUFBUixDQUFnQix1RUFBc0VILElBQUlJLE9BQVEsR0FBbEc7QUFBb0c7O0FBRXRHLE1BQU0sRUFBQ0Ms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QyxTQUFKLENBQWlCLCtDQUFqQixDQUFOO0FBQXFFO0FBQ3ZFLFdBQVMsRUFBQ3ZDLFNBQUQsRUFBWXdDLFdBQVcsSUFBdkIsRUFBVDtBQUFvQyxHQXpCMUI7O0FBMkJaQyxVQUFRekMsWUFBVSxLQUFLQSxTQUF2QixFQUFrQztBQUNoQyxRQUFJMEMsWUFBWW5ELGNBQ1pVLFNBQVNXLEdBQVQsQ0FBZXJCLFlBQVlFLGdCQUFaLEVBQWYsQ0FEWSxHQUVaRyxTQUZKOztBQUlBLFFBQUdBLGNBQWM4QyxTQUFqQixFQUE2QjtBQUMzQkEsa0JBQVksSUFBSWhELEtBQUosQ0FBYSxxQkFBYixDQUFaO0FBQTZDO0FBQy9DLFdBQU8sSUFBSU0sU0FBSixDQUFnQjBDLFNBQWhCLEVBQTJCMUIsV0FBM0IsQ0FBUDtBQUE2QyxHQWxDbkM7O0FBb0NaMkIsUUFBTUEsS0FBTixFQUFhO0FBQ1gsV0FBTyxLQUFLRixPQUFMLEdBQWVHLFNBQWYsQ0FBeUJELEtBQXpCLENBQVA7QUFBc0MsR0FyQzVCOztBQXVDWkUsZ0JBQWM7QUFDWixXQUFPLEtBQUtKLE9BQUwsR0FBZUksV0FBZixFQUFQO0FBQW1DLEdBeEN6QixFQUFkOztBQTBDQW5CLElBQUlBLEdBQUosR0FBVUEsSUFBSW9CLE9BQUosR0FBY3BCLEdBQXhCO0FBQ0FxQixPQUFPQyxPQUFQLEdBQWlCQSxVQUFVdEIsR0FBM0IiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJ0cnkgOjpcbiAgdmFyIGFzeW5jX2hvb2tzID0gcmVxdWlyZSgnYXN5bmNfaG9va3MnKVxuICBpZiAnZnVuY3Rpb24nICE9PSB0eXBlb2YgYXN5bmNfaG9va3MuZXhlY3V0aW9uQXN5bmNJZCA6OlxuICAgIHRocm93IG5ldyBFcnJvciBAIGBNaXNzaW5nIGV4ZWN1dGlvbkFzeW5jSWQgZnVuY3Rpb25gXG5jYXRjaCBlcnIgOjpcbiAgYXN5bmNfaG9va3MgPSB1bmRlZmluZWRcbiAgY29uc29sZS53YXJuIEAgYFVuYWJsZSB0byBsb2FkIGFzeW5jX2hvb2tzIG1vZHVsZSAoTm9kZSA4LjIrIHJlcXVpcmVkKS5cXG4gIChyZWFzb246ICR7ZXJyLm1lc3NhZ2V9KWBcblxuY29uc3Qge1RyYWNlYmFja30gPSByZXF1aXJlKCcuL3RyYWNlYmFjaycpXG5cbmNvbnN0IGRiX3RyYWNlID0gbmV3IE1hcCgpXG5cbmNvbnN0IGhvb2tfdHJhY2UgPSBhc3luY19ob29rc1xuICA/IGFzeW5jX2hvb2tzLmNyZWF0ZUhvb2sgQDpcbiAgICAgIGRlc3Ryb3koYXN5bmNJZCkgOjpcbiAgICAgICAgZGJfdHJhY2UuZGVsZXRlIEAgYXN5bmNJZFxuICAgICAgaW5pdChhc3luY0lkLCB0eXBlLCB0cmlnZ2VySWQpIDo6XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IGRiX3RyYWNlLmdldCh0cmlnZ2VySWQpXG4gICAgICAgIGNvbnN0IGRlcHRoID0gdW5kZWZpbmVkICE9PSBwYXJlbnQgPyAxICsgcGFyZW50LmRlcHRoIDogMVxuICAgICAgICBjb25zdCBrZXkgPSBgQ1BTWyR7ZGVwdGh9XTo6JHt0eXBlfWBcblxuICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3Ioa2V5KVxuICAgICAgICBlcnIudHJpZ2dlcklkID0gdHJpZ2dlcklkXG4gICAgICAgIGVyci5kZXB0aCA9IGRlcHRoXG5cbiAgICAgICAgaWYgdW5kZWZpbmVkICE9PSBwYXJlbnQgOjpcbiAgICAgICAgICBsZXQgZWFybHkgPSBwYXJlbnQuZWFybHlcbiAgICAgICAgICBpZiB1bmRlZmluZWQgPT09IGVhcmx5ICYmIDExID09PSBkZXB0aCA6OlxuICAgICAgICAgICAgZWFybHkgPSBhc0ZyYW1lTGlzdCh0cmlnZ2VySWQpXG4gICAgICAgICAgaWYgdW5kZWZpbmVkICE9PSBlYXJseSA6OlxuICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMgQCBlcnIsIHtlYXJseTogeyB2YWx1ZTogZWFybHkgfX1cblxuICAgICAgICBkYl90cmFjZS5zZXQgQCBhc3luY0lkLCBlcnJcbiAgOiBudWxsXG5cblxuXG5mdW5jdGlvbiBhc0ZyYW1lTGlzdCh0cmlnZ2VySWQsIGxpbWl0KSA6OlxuICBjb25zdCByZXMgPSBbXVxuICBpZiB0cmlnZ2VySWQudHJpZ2dlcklkICYmIHRyaWdnZXJJZC5kZXB0aCA6OlxuICAgIHJlcy5wdXNoIEAgdHJpZ2dlcklkXG4gICAgdHJpZ2dlcklkID0gdHJpZ2dlcklkLnRyaWdnZXJJZFxuXG4gIHdoaWxlIHRyaWdnZXJJZCA6OlxuICAgIGNvbnN0IGZyYW1lID0gZGJfdHJhY2UuZ2V0KHRyaWdnZXJJZClcbiAgICBpZiBmcmFtZSA9PT0gdW5kZWZpbmVkIDo6IGJyZWFrXG4gICAgcmVzLnB1c2ggQCBmcmFtZVxuICAgIGlmIHJlcy5sZW5ndGggPj0gbGltaXQgOjogYnJlYWtcbiAgICB0cmlnZ2VySWQgPSBmcmFtZS50cmlnZ2VySWRcblxuICByZXR1cm4gcmVzXG5cblxuY29uc3QgYXBpID0gQDpcbiAgVHJhY2ViYWNrXG5cbiAgaXNTdXBwb3J0ZWQoKSA6OlxuICAgIHJldHVybiAhISBob29rX3RyYWNlXG4gIGlzQWN0aXZlKCkgOjpcbiAgICByZXR1cm4gaG9va190cmFjZSA/IGhvb2tfdHJhY2UuYWN0aXZlIDogdW5kZWZpbmVkXG5cbiAgaW5zdGFsbCgpIDo6XG4gICAgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID0gTWF0aC5tYXggQCAzMCwgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0XG4gICAgaWYgaG9va190cmFjZSA6OlxuICAgICAgaG9va190cmFjZS5lbmFibGUoKVxuICAgICAgaG9va190cmFjZS5hY3RpdmUgPSB0cnVlXG4gICAgcmV0dXJuIHRoaXNcblxuICB1bmluc3RhbGwoKSA6OlxuICAgIGRiX3RyYWNlLmNsZWFyKClcbiAgICBpZiBob29rX3RyYWNlIDo6XG4gICAgICBob29rX3RyYWNlLmRpc2FibGUoKVxuICAgICAgaG9va190cmFjZS5hY3RpdmUgPSBmYWxzZVxuICAgIHJldHVybiB0aGlzXG5cbiAgd2l0aFRyYWNlYmFjayhUcmFjZWJhY2spIDo6XG4gICAgaWYgJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIFRyYWNlYmFjayA6OlxuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvciBAIGBFeHBlY3RlZCBhbiBUcmFjZWJhY2sgZnVuY3Rpb24gc3VwcG9ydGluZyBuZXdgXG4gICAgcmV0dXJuIEA6IFRyYWNlYmFjaywgX19wcm90b19fOiB0aGlzXG5cbiAgY2FwdHVyZShUcmFjZWJhY2s9dGhpcy5UcmFjZWJhY2spIDo6XG4gICAgbGV0IHJhd190cmFjZSA9IGFzeW5jX2hvb2tzXG4gICAgICA/IGRiX3RyYWNlLmdldCBAIGFzeW5jX2hvb2tzLmV4ZWN1dGlvbkFzeW5jSWQoKVxuICAgICAgOiB1bmRlZmluZWRcblxuICAgIGlmIHVuZGVmaW5lZCA9PT0gcmF3X3RyYWNlIDo6XG4gICAgICByYXdfdHJhY2UgPSBuZXcgRXJyb3IgQCBgQ1BTWz9dOjp1bmF2YWlsYWJsZWBcbiAgICByZXR1cm4gbmV3IFRyYWNlYmFjayBAIHJhd190cmFjZSwgYXNGcmFtZUxpc3RcblxuICBlcnJvcihlcnJvcikgOjpcbiAgICByZXR1cm4gdGhpcy5jYXB0dXJlKCkud2l0aEVycm9yKGVycm9yKVxuXG4gIGFzeW5jX3N0YWNrKCkgOjpcbiAgICByZXR1cm4gdGhpcy5jYXB0dXJlKCkuYXN5bmNfc3RhY2soKVxuXG5hcGkuYXBpID0gYXBpLmRlZmF1bHQgPSBhcGlcbm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGFwaVxuIl19