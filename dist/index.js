'use strict';

try {
  var async_hooks = require('async_hooks');
  if ('function' !== typeof async_hooks.executionAsyncId) {
    throw new Error(`Missing executionAsyncId function`);
  }
} catch (err) {
  async_hooks = undefined;
  console.warn(`Unable to load async_hooks module (Node 8.2+ required).\n  (reason: ${err.message})`);
}

const { Traceback } = require('./traceback');

const db_trace = new Map();

const hook_trace = async_hooks ? async_hooks.createHook({
  destroy(asyncId) {
    db_trace.delete(asyncId);
  }, init(asyncId, type, triggerId) {
    const parent = db_trace.get(triggerId);
    const depth = undefined !== parent ? 1 + parent.depth : 1;
    const key = `CPS[${depth}]::${type}`;

    const err = new Error(key);
    err.triggerId = triggerId;
    err.depth = depth;

    if (undefined !== parent) {
      let early = parent.early;
      if (undefined === early && 11 === depth) {
        early = asFrameList(triggerId);
      }
      if (undefined !== early) {
        Object.defineProperties(err, { early: { value: early } });
      }
    }

    db_trace.set(asyncId, err);
  } }) : null;

function asFrameList(triggerId, limit) {
  const res = [];
  if (triggerId.triggerId && triggerId.depth) {
    res.push(triggerId);
    triggerId = triggerId.triggerId;
  }

  while (triggerId) {
    const frame = db_trace.get(triggerId);
    if (frame === undefined) {
      break;
    }
    res.push(frame);
    if (res.length >= limit) {
      break;
    }
    triggerId = frame.triggerId;
  }

  return res;
}

const api = { Traceback,
  isSupported() {
    return !!hook_trace;
  }, isActive() {
    return hook_trace ? hook_trace.active : undefined;
  }, install() {
    Error.stackTraceLimit = Math.max(30, Error.stackTraceLimit);
    if (hook_trace) {
      hook_trace.enable();
      hook_trace.active = true;
    }
    return this;
  }, uninstall() {
    db_trace.clear();
    if (hook_trace) {
      hook_trace.disable();
      hook_trace.active = false;
    }
    return this;
  }, withTraceback(Traceback) {
    if ('function' !== typeof Traceback) {
      throw new TypeError(`Expected an Traceback function supporting new`);
    }
    return { Traceback, __proto__: this };
  }, capture(Traceback = this.Traceback) {
    let raw_trace = async_hooks ? db_trace.get(async_hooks.executionAsyncId()) : undefined;

    if (undefined === raw_trace) {
      raw_trace = new Error(`CPS[?]::unavailable`);
    }
    return new Traceback(raw_trace, asFrameList);
  }, error(error) {
    return this.capture().withError(error);
  }, async_stack() {
    return this.capture().async_stack();
  } };

api.api = api.default = api;
module.exports = exports = api;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NvZGUvaW5kZXguanN5Il0sIm5hbWVzIjpbImFzeW5jX2hvb2tzIiwicmVxdWlyZSIsImV4ZWN1dGlvbkFzeW5jSWQiLCJFcnJvciIsImVyciIsInVuZGVmaW5lZCIsImNvbnNvbGUiLCJ3YXJuIiwibWVzc2FnZSIsIlRyYWNlYmFjayIsImRiX3RyYWNlIiwiTWFwIiwiaG9va190cmFjZSIsImNyZWF0ZUhvb2siLCJkZXN0cm95IiwiYXN5bmNJZCIsImRlbGV0ZSIsImluaXQiLCJ0eXBlIiwidHJpZ2dlcklkIiwicGFyZW50IiwiZ2V0IiwiZGVwdGgiLCJrZXkiLCJlYXJseSIsImFzRnJhbWVMaXN0IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydGllcyIsInZhbHVlIiwic2V0IiwibGltaXQiLCJyZXMiLCJwdXNoIiwiZnJhbWUiLCJsZW5ndGgiLCJhcGkiLCJpc1N1cHBvcnRlZCIsImlzQWN0aXZlIiwiYWN0aXZlIiwiaW5zdGFsbCIsInN0YWNrVHJhY2VMaW1pdCIsIk1hdGgiLCJtYXgiLCJlbmFibGUiLCJ1bmluc3RhbGwiLCJjbGVhciIsImRpc2FibGUiLCJ3aXRoVHJhY2ViYWNrIiwiVHlwZUVycm9yIiwiX19wcm90b19fIiwiY2FwdHVyZSIsInJhd190cmFjZSIsImVycm9yIiwid2l0aEVycm9yIiwiYXN5bmNfc3RhY2siLCJkZWZhdWx0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJO0FBQ0YsTUFBSUEsY0FBY0MsUUFBUSxhQUFSLENBQWxCO0FBQ0EsTUFBRyxlQUFlLE9BQU9ELFlBQVlFLGdCQUFyQyxFQUF3RDtBQUN0RCxVQUFNLElBQUlDLEtBQUosQ0FBYSxtQ0FBYixDQUFOO0FBQXFEO0FBQUEsQ0FIekQsQ0FJQSxPQUFNQyxHQUFOLEVBQVk7QUFDVkosZ0JBQWNLLFNBQWQ7QUFDQUMsVUFBUUMsSUFBUixDQUFnQix1RUFBc0VILElBQUlJLE9BQVEsR0FBbEc7QUFBb0c7O0FBRXRHLE1BQU0sRUFBQ0Ms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SixDQUFpQiwrQ0FBakIsQ0FBTjtBQUFxRTtBQUN2RSxXQUFTLEVBQUN2QyxTQUFELEVBQVl3QyxXQUFXLElBQXZCLEVBQVQ7QUFBb0MsR0F2QjVCLEVBeUJWQyxRQUFRekMsWUFBVSxLQUFLQSxTQUF2QixFQUFrQztBQUNoQyxRQUFJMEMsWUFBWW5ELGNBQ1pVLFNBQVNXLEdBQVQsQ0FBZXJCLFlBQVlFLGdCQUFaLEVBQWYsQ0FEWSxHQUVaRyxTQUZKOztBQUlBLFFBQUdBLGNBQWM4QyxTQUFqQixFQUE2QjtBQUMzQkEsa0JBQVksSUFBSWhELEtBQUosQ0FBYSxxQkFBYixDQUFaO0FBQTZDO0FBQy9DLFdBQU8sSUFBSU0sU0FBSixDQUFnQjBDLFNBQWhCLEVBQTJCMUIsV0FBM0IsQ0FBUDtBQUE2QyxHQWhDckMsRUFrQ1YyQixNQUFNQSxLQUFOLEVBQWE7QUFDWCxXQUFPLEtBQUtGLE9BQUwsR0FBZUcsU0FBZixDQUF5QkQsS0FBekIsQ0FBUDtBQUFzQyxHQW5DOUIsRUFxQ1ZFLGNBQWM7QUFDWixXQUFPLEtBQUtKLE9BQUwsR0FBZUksV0FBZixFQUFQO0FBQW1DLEdBdEMzQixFQUFkOztBQXdDQW5CLElBQUlBLEdBQUosR0FBVUEsSUFBSW9CLE9BQUosR0FBY3BCLEdBQXhCO0FBQ0FxQixPQUFPQyxPQUFQLEdBQWlCQSxVQUFVdEIsR0FBM0IiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJ0cnkgOjpcbiAgdmFyIGFzeW5jX2hvb2tzID0gcmVxdWlyZSgnYXN5bmNfaG9va3MnKVxuICBpZiAnZnVuY3Rpb24nICE9PSB0eXBlb2YgYXN5bmNfaG9va3MuZXhlY3V0aW9uQXN5bmNJZCA6OlxuICAgIHRocm93IG5ldyBFcnJvciBAIGBNaXNzaW5nIGV4ZWN1dGlvbkFzeW5jSWQgZnVuY3Rpb25gXG5jYXRjaCBlcnIgOjpcbiAgYXN5bmNfaG9va3MgPSB1bmRlZmluZWRcbiAgY29uc29sZS53YXJuIEAgYFVuYWJsZSB0byBsb2FkIGFzeW5jX2hvb2tzIG1vZHVsZSAoTm9kZSA4LjIrIHJlcXVpcmVkKS5cXG4gIChyZWFzb246ICR7ZXJyLm1lc3NhZ2V9KWBcblxuY29uc3Qge1RyYWNlYmFja30gPSByZXF1aXJlKCcuL3RyYWNlYmFjaycpXG5cbmNvbnN0IGRiX3RyYWNlID0gbmV3IE1hcCgpXG5cbmNvbnN0IGhvb2tfdHJhY2UgPSBhc3luY19ob29rc1xuICA/IGFzeW5jX2hvb2tzLmNyZWF0ZUhvb2sgQDpcbiAgICAgICAgZGVzdHJveShhc3luY0lkKSA6OlxuICAgICAgICAgIGRiX3RyYWNlLmRlbGV0ZSBAIGFzeW5jSWRcbiAgICAgICwgaW5pdChhc3luY0lkLCB0eXBlLCB0cmlnZ2VySWQpIDo6XG4gICAgICAgICAgY29uc3QgcGFyZW50ID0gZGJfdHJhY2UuZ2V0KHRyaWdnZXJJZClcbiAgICAgICAgICBjb25zdCBkZXB0aCA9IHVuZGVmaW5lZCAhPT0gcGFyZW50ID8gMSArIHBhcmVudC5kZXB0aCA6IDFcbiAgICAgICAgICBjb25zdCBrZXkgPSBgQ1BTWyR7ZGVwdGh9XTo6JHt0eXBlfWBcblxuICAgICAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihrZXkpXG4gICAgICAgICAgZXJyLnRyaWdnZXJJZCA9IHRyaWdnZXJJZFxuICAgICAgICAgIGVyci5kZXB0aCA9IGRlcHRoXG5cbiAgICAgICAgICBpZiB1bmRlZmluZWQgIT09IHBhcmVudCA6OlxuICAgICAgICAgICAgbGV0IGVhcmx5ID0gcGFyZW50LmVhcmx5XG4gICAgICAgICAgICBpZiB1bmRlZmluZWQgPT09IGVhcmx5ICYmIDExID09PSBkZXB0aCA6OlxuICAgICAgICAgICAgICBlYXJseSA9IGFzRnJhbWVMaXN0KHRyaWdnZXJJZClcbiAgICAgICAgICAgIGlmIHVuZGVmaW5lZCAhPT0gZWFybHkgOjpcbiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMgQCBlcnIsIHtlYXJseTogeyB2YWx1ZTogZWFybHkgfX1cblxuICAgICAgICAgIGRiX3RyYWNlLnNldCBAIGFzeW5jSWQsIGVyclxuICA6IG51bGxcblxuXG5cbmZ1bmN0aW9uIGFzRnJhbWVMaXN0KHRyaWdnZXJJZCwgbGltaXQpIDo6XG4gIGNvbnN0IHJlcyA9IFtdXG4gIGlmIHRyaWdnZXJJZC50cmlnZ2VySWQgJiYgdHJpZ2dlcklkLmRlcHRoIDo6XG4gICAgcmVzLnB1c2ggQCB0cmlnZ2VySWRcbiAgICB0cmlnZ2VySWQgPSB0cmlnZ2VySWQudHJpZ2dlcklkXG5cbiAgd2hpbGUgdHJpZ2dlcklkIDo6XG4gICAgY29uc3QgZnJhbWUgPSBkYl90cmFjZS5nZXQodHJpZ2dlcklkKVxuICAgIGlmIGZyYW1lID09PSB1bmRlZmluZWQgOjogYnJlYWtcbiAgICByZXMucHVzaCBAIGZyYW1lXG4gICAgaWYgcmVzLmxlbmd0aCA+PSBsaW1pdCA6OiBicmVha1xuICAgIHRyaWdnZXJJZCA9IGZyYW1lLnRyaWdnZXJJZFxuXG4gIHJldHVybiByZXNcblxuXG5jb25zdCBhcGkgPSBAOiBUcmFjZWJhY2tcbiAgLCBpc1N1cHBvcnRlZCgpIDo6XG4gICAgICByZXR1cm4gISEgaG9va190cmFjZVxuICAsIGlzQWN0aXZlKCkgOjpcbiAgICAgIHJldHVybiBob29rX3RyYWNlID8gaG9va190cmFjZS5hY3RpdmUgOiB1bmRlZmluZWRcblxuICAsIGluc3RhbGwoKSA6OlxuICAgICAgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID0gTWF0aC5tYXggQCAzMCwgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0XG4gICAgICBpZiBob29rX3RyYWNlIDo6XG4gICAgICAgIGhvb2tfdHJhY2UuZW5hYmxlKClcbiAgICAgICAgaG9va190cmFjZS5hY3RpdmUgPSB0cnVlXG4gICAgICByZXR1cm4gdGhpc1xuXG4gICwgdW5pbnN0YWxsKCkgOjpcbiAgICAgIGRiX3RyYWNlLmNsZWFyKClcbiAgICAgIGlmIGhvb2tfdHJhY2UgOjpcbiAgICAgICAgaG9va190cmFjZS5kaXNhYmxlKClcbiAgICAgICAgaG9va190cmFjZS5hY3RpdmUgPSBmYWxzZVxuICAgICAgcmV0dXJuIHRoaXNcblxuICAsIHdpdGhUcmFjZWJhY2soVHJhY2ViYWNrKSA6OlxuICAgICAgaWYgJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIFRyYWNlYmFjayA6OlxuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yIEAgYEV4cGVjdGVkIGFuIFRyYWNlYmFjayBmdW5jdGlvbiBzdXBwb3J0aW5nIG5ld2BcbiAgICAgIHJldHVybiBAOiBUcmFjZWJhY2ssIF9fcHJvdG9fXzogdGhpc1xuXG4gICwgY2FwdHVyZShUcmFjZWJhY2s9dGhpcy5UcmFjZWJhY2spIDo6XG4gICAgICBsZXQgcmF3X3RyYWNlID0gYXN5bmNfaG9va3NcbiAgICAgICAgPyBkYl90cmFjZS5nZXQgQCBhc3luY19ob29rcy5leGVjdXRpb25Bc3luY0lkKClcbiAgICAgICAgOiB1bmRlZmluZWRcblxuICAgICAgaWYgdW5kZWZpbmVkID09PSByYXdfdHJhY2UgOjpcbiAgICAgICAgcmF3X3RyYWNlID0gbmV3IEVycm9yIEAgYENQU1s/XTo6dW5hdmFpbGFibGVgXG4gICAgICByZXR1cm4gbmV3IFRyYWNlYmFjayBAIHJhd190cmFjZSwgYXNGcmFtZUxpc3RcblxuICAsIGVycm9yKGVycm9yKSA6OlxuICAgICAgcmV0dXJuIHRoaXMuY2FwdHVyZSgpLndpdGhFcnJvcihlcnJvcilcblxuICAsIGFzeW5jX3N0YWNrKCkgOjpcbiAgICAgIHJldHVybiB0aGlzLmNhcHR1cmUoKS5hc3luY19zdGFjaygpXG5cbmFwaS5hcGkgPSBhcGkuZGVmYXVsdCA9IGFwaVxubW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gYXBpXG4iXX0=